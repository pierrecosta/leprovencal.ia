{"ast":null,"code":"var _s = $RefreshSig$();\n// hooks/useAuth.js\nimport { useEffect, useState, useCallback } from 'react';\nimport { clearToken, getMe, getToken } from '../services/api';\nimport { logError } from '../utils/logger';\n\n// Ensure /auth/me is called once per page load even if useAuth() is used in many components.\nlet _mePromise = null;\nlet _meValue = null;\nasync function getMeOnce() {\n  if (_meValue) return _meValue;\n  if (!_mePromise) {\n    _mePromise = getMe().then(me => {\n      _meValue = me;\n      return me;\n    }).finally(() => {\n      _mePromise = null;\n    });\n  }\n  return _mePromise;\n}\nexport function useAuth() {\n  _s();\n  const [user, setUser] = useState(null);\n  const [ready, setReady] = useState(false);\n  useEffect(() => {\n    const onLogout = () => {\n      setUser(null);\n      setReady(true);\n    };\n    window.addEventListener('auth:logout', onLogout);\n    return () => window.removeEventListener('auth:logout', onLogout);\n  }, []);\n  useEffect(() => {\n    const token = getToken();\n    if (!token) {\n      setReady(true);\n      return;\n    }\n    (async () => {\n      try {\n        const me = await getMeOnce();\n        setUser(me);\n      } catch (err) {\n        logError(err);\n        setUser(null);\n        clearToken();\n      } finally {\n        setReady(true);\n      }\n    })();\n  }, []);\n  const logout = useCallback(() => {\n    clearToken();\n    setUser(null);\n  }, []);\n  return {\n    user,\n    ready,\n    logout\n  };\n}\n_s(useAuth, \"FHCll1f6jIfrPTHie+kO3e4xtQk=\");","map":{"version":3,"names":["useEffect","useState","useCallback","clearToken","getMe","getToken","logError","_mePromise","_meValue","getMeOnce","then","me","finally","useAuth","_s","user","setUser","ready","setReady","onLogout","window","addEventListener","removeEventListener","token","err","logout"],"sources":["/mnt/c/code/leprovencal.ia/frontend/src/hooks/useAuth.js"],"sourcesContent":["// hooks/useAuth.js\r\nimport { useEffect, useState, useCallback } from 'react';\r\nimport { clearToken, getMe, getToken } from '../services/api';\r\nimport { logError } from '../utils/logger';\r\n\r\n// Ensure /auth/me is called once per page load even if useAuth() is used in many components.\r\nlet _mePromise = null;\r\nlet _meValue = null;\r\n\r\nasync function getMeOnce() {\r\n  if (_meValue) return _meValue;\r\n  if (!_mePromise) {\r\n    _mePromise = getMe()\r\n      .then((me) => {\r\n        _meValue = me;\r\n        return me;\r\n      })\r\n      .finally(() => {\r\n        _mePromise = null;\r\n      });\r\n  }\r\n  return _mePromise;\r\n}\r\n\r\nexport function useAuth() {\r\n  const [user, setUser] = useState(null);\r\n  const [ready, setReady] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const onLogout = () => {\r\n      setUser(null);\r\n      setReady(true);\r\n    };\r\n    window.addEventListener('auth:logout', onLogout);\r\n    return () => window.removeEventListener('auth:logout', onLogout);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const token = getToken();\r\n    if (!token) {\r\n      setReady(true);\r\n      return;\r\n    }\r\n\r\n    (async () => {\r\n      try {\r\n        const me = await getMeOnce();\r\n        setUser(me);\r\n      } catch (err) {\r\n        logError(err);\r\n        setUser(null);\r\n        clearToken();\r\n      } finally {\r\n        setReady(true);\r\n      }\r\n    })();\r\n  }, []);\r\n\r\n  const logout = useCallback(() => {\r\n    clearToken();\r\n    setUser(null);\r\n  }, []);\r\n\r\n  return { user, ready, logout };\r\n}\r\n"],"mappings":";AAAA;AACA,SAASA,SAAS,EAAEC,QAAQ,EAAEC,WAAW,QAAQ,OAAO;AACxD,SAASC,UAAU,EAAEC,KAAK,EAAEC,QAAQ,QAAQ,iBAAiB;AAC7D,SAASC,QAAQ,QAAQ,iBAAiB;;AAE1C;AACA,IAAIC,UAAU,GAAG,IAAI;AACrB,IAAIC,QAAQ,GAAG,IAAI;AAEnB,eAAeC,SAASA,CAAA,EAAG;EACzB,IAAID,QAAQ,EAAE,OAAOA,QAAQ;EAC7B,IAAI,CAACD,UAAU,EAAE;IACfA,UAAU,GAAGH,KAAK,CAAC,CAAC,CACjBM,IAAI,CAAEC,EAAE,IAAK;MACZH,QAAQ,GAAGG,EAAE;MACb,OAAOA,EAAE;IACX,CAAC,CAAC,CACDC,OAAO,CAAC,MAAM;MACbL,UAAU,GAAG,IAAI;IACnB,CAAC,CAAC;EACN;EACA,OAAOA,UAAU;AACnB;AAEA,OAAO,SAASM,OAAOA,CAAA,EAAG;EAAAC,EAAA;EACxB,MAAM,CAACC,IAAI,EAAEC,OAAO,CAAC,GAAGf,QAAQ,CAAC,IAAI,CAAC;EACtC,MAAM,CAACgB,KAAK,EAAEC,QAAQ,CAAC,GAAGjB,QAAQ,CAAC,KAAK,CAAC;EAEzCD,SAAS,CAAC,MAAM;IACd,MAAMmB,QAAQ,GAAGA,CAAA,KAAM;MACrBH,OAAO,CAAC,IAAI,CAAC;MACbE,QAAQ,CAAC,IAAI,CAAC;IAChB,CAAC;IACDE,MAAM,CAACC,gBAAgB,CAAC,aAAa,EAAEF,QAAQ,CAAC;IAChD,OAAO,MAAMC,MAAM,CAACE,mBAAmB,CAAC,aAAa,EAAEH,QAAQ,CAAC;EAClE,CAAC,EAAE,EAAE,CAAC;EAENnB,SAAS,CAAC,MAAM;IACd,MAAMuB,KAAK,GAAGlB,QAAQ,CAAC,CAAC;IACxB,IAAI,CAACkB,KAAK,EAAE;MACVL,QAAQ,CAAC,IAAI,CAAC;MACd;IACF;IAEA,CAAC,YAAY;MACX,IAAI;QACF,MAAMP,EAAE,GAAG,MAAMF,SAAS,CAAC,CAAC;QAC5BO,OAAO,CAACL,EAAE,CAAC;MACb,CAAC,CAAC,OAAOa,GAAG,EAAE;QACZlB,QAAQ,CAACkB,GAAG,CAAC;QACbR,OAAO,CAAC,IAAI,CAAC;QACbb,UAAU,CAAC,CAAC;MACd,CAAC,SAAS;QACRe,QAAQ,CAAC,IAAI,CAAC;MAChB;IACF,CAAC,EAAE,CAAC;EACN,CAAC,EAAE,EAAE,CAAC;EAEN,MAAMO,MAAM,GAAGvB,WAAW,CAAC,MAAM;IAC/BC,UAAU,CAAC,CAAC;IACZa,OAAO,CAAC,IAAI,CAAC;EACf,CAAC,EAAE,EAAE,CAAC;EAEN,OAAO;IAAED,IAAI;IAAEE,KAAK;IAAEQ;EAAO,CAAC;AAChC;AAACX,EAAA,CAxCeD,OAAO","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}