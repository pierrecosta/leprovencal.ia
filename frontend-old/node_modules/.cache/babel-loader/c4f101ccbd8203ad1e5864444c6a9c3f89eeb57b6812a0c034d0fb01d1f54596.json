{"ast":null,"code":"// hooks/useAuth.js\nimport React,{createContext,useCallback,useContext,useEffect,useMemo,useState}from'react';import{clearToken,getMe}from'../services/api';import{logError}from'../utils/logger';// A small cache so we don't hammer `/auth/me` on initial render when many components mount.\nimport{jsx as _jsx}from\"react/jsx-runtime\";let _mePromise=null;let _meValue=null;async function getMeOnce(){if(_meValue)return _meValue;if(!_mePromise){_mePromise=getMe().then(me=>{_meValue=me;return me;}).finally(()=>{_mePromise=null;});}return _mePromise;}const AuthContext=/*#__PURE__*/createContext(null);export function AuthProvider(_ref){let{children}=_ref;const[user,setUser]=useState(null);const[ready,setReady]=useState(false);// load current user once on mount\nuseEffect(()=>{let mounted=true;(async()=>{try{const me=await getMeOnce();if(mounted)setUser(me);}catch(err){var _err$response;const status=err===null||err===void 0?void 0:(_err$response=err.response)===null||_err$response===void 0?void 0:_err$response.status;if(status!==401)logError(err);if(mounted)setUser(null);}finally{if(mounted)setReady(true);}})();return()=>{mounted=false;};},[]);// listen for auth events within the same tab\nuseEffect(()=>{const onLogin=async()=>{try{const me=await getMe();_meValue=me;setUser(me);}catch(err){var _err$response2;const status=err===null||err===void 0?void 0:(_err$response2=err.response)===null||_err$response2===void 0?void 0:_err$response2.status;if(status!==401)logError(err);_meValue=null;setUser(null);}};const onLogout=()=>{_meValue=null;setUser(null);setReady(true);};window.addEventListener('auth:login',onLogin);window.addEventListener('auth:logout',onLogout);return()=>{window.removeEventListener('auth:login',onLogin);window.removeEventListener('auth:logout',onLogout);};},[]);const logout=useCallback(()=>{clearToken();// services/api should emit auth:logout\n_meValue=null;setUser(null);},[]);const value=useMemo(()=>({user,ready,logout,setUser}),[user,ready,logout]);return/*#__PURE__*/_jsx(AuthContext.Provider,{value:value,children:children});}export function useAuth(){const ctx=useContext(AuthContext);if(!ctx){throw new Error('useAuth must be used within an AuthProvider');}return ctx;}","map":{"version":3,"names":["React","createContext","useCallback","useContext","useEffect","useMemo","useState","clearToken","getMe","logError","jsx","_jsx","_mePromise","_meValue","getMeOnce","then","me","finally","AuthContext","AuthProvider","_ref","children","user","setUser","ready","setReady","mounted","err","_err$response","status","response","onLogin","_err$response2","onLogout","window","addEventListener","removeEventListener","logout","value","Provider","useAuth","ctx","Error"],"sources":["/mnt/c/code/leprovencal.ia/frontend/src/hooks/useAuth.js"],"sourcesContent":["// hooks/useAuth.js\r\nimport React, { createContext, useCallback, useContext, useEffect, useMemo, useState } from 'react';\r\nimport { clearToken, getMe } from '../services/api';\r\nimport { logError } from '../utils/logger';\r\n\r\n// A small cache so we don't hammer `/auth/me` on initial render when many components mount.\r\nlet _mePromise = null;\r\nlet _meValue = null;\r\n\r\nasync function getMeOnce() {\r\n  if (_meValue) return _meValue;\r\n  if (!_mePromise) {\r\n    _mePromise = getMe()\r\n      .then((me) => {\r\n        _meValue = me;\r\n        return me;\r\n      })\r\n      .finally(() => {\r\n        _mePromise = null;\r\n      });\r\n  }\r\n  return _mePromise;\r\n}\r\n\r\nconst AuthContext = createContext(null);\r\n\r\nexport function AuthProvider({ children }) {\r\n  const [user, setUser] = useState(null);\r\n  const [ready, setReady] = useState(false);\r\n\r\n  // load current user once on mount\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    (async () => {\r\n      try {\r\n        const me = await getMeOnce();\r\n        if (mounted) setUser(me);\r\n      } catch (err) {\r\n        const status = err?.response?.status;\r\n        if (status !== 401) logError(err);\r\n        if (mounted) setUser(null);\r\n      } finally {\r\n        if (mounted) setReady(true);\r\n      }\r\n    })();\r\n    return () => {\r\n      mounted = false;\r\n    };\r\n  }, []);\r\n\r\n  // listen for auth events within the same tab\r\n  useEffect(() => {\r\n    const onLogin = async () => {\r\n      try {\r\n        const me = await getMe();\r\n        _meValue = me;\r\n        setUser(me);\r\n      } catch (err) {\r\n        const status = err?.response?.status;\r\n        if (status !== 401) logError(err);\r\n        _meValue = null;\r\n        setUser(null);\r\n      }\r\n    };\r\n\r\n    const onLogout = () => {\r\n      _meValue = null;\r\n      setUser(null);\r\n      setReady(true);\r\n    };\r\n\r\n    window.addEventListener('auth:login', onLogin);\r\n    window.addEventListener('auth:logout', onLogout);\r\n    return () => {\r\n      window.removeEventListener('auth:login', onLogin);\r\n      window.removeEventListener('auth:logout', onLogout);\r\n    };\r\n  }, []);\r\n\r\n  const logout = useCallback(() => {\r\n    clearToken(); // services/api should emit auth:logout\r\n    _meValue = null;\r\n    setUser(null);\r\n  }, []);\r\n\r\n  const value = useMemo(() => ({ user, ready, logout, setUser }), [user, ready, logout]);\r\n\r\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\r\n}\r\n\r\nexport function useAuth() {\r\n  const ctx = useContext(AuthContext);\r\n  if (!ctx) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return ctx;\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}